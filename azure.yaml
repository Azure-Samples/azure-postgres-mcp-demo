# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: azure-mcp-server
metadata:
  template: azure-mcp-server@0.0.1-beta

infra:
  provider: bicep
  path: ./infra
  outputs:
    AZURE_RESOURCE_GROUP: RESOURCE_GROUP_NAME
    CONTAINER_REGISTRY_LOGIN_SERVER: CONTAINER_REGISTRY_LOGIN_SERVER
    CONTAINER_APP_NAME: CONTAINER_APP_NAME
    AZURE_CONTAINER_APPS_ENVIRONMENT_ID: AZURE_CONTAINER_APP_ENVIRONMENT_ID
    APPLICATION_INSIGHTS_CONNECTION_STRING: APPLICATION_INSIGHTS_CONNECTION_STRING
    AZURE_MCP_COLLECT_TELEMETRY: AZURE_MCP_COLLECT_TELEMETRY

services:
  api:
    resourceName: ${CONTAINER_APP_NAME}
    project: ./server/src
    host: containerapp
    language: dotnet
    docker:
      path: ./docker/Dockerfile
      context: ./server/src
      registry: ${CONTAINER_REGISTRY_LOGIN_SERVER}

hooks:
  preprovision:
    shell: sh
    run: echo "Starting 'Azure MCP Postgres Server' infrastructure provisioning..."
    continueOnError: false
  
  postprovision:
    shell: sh  
    run: |
      echo "Success: Infrastructure provisioned"
      echo "Updating 'Azure MCP Postgres Server' application's 'appsettings.json' with Entra App configuration..."
      ./infra/update-appsettings.sh
    continueOnError: false

  predeploy:
    shell: sh
    run: echo "Building and deploying 'Azure MCP Postgres Server' application..."
    continueOnError: false

  postdeploy:
    shell: sh
    run: |
      echo "Success: 'Azure MCP Postgres Server' deployed"
      echo "Saving deployment info to azd-deployment-info.json..."
      azd env get-values -o json > azd-deployment-info.json
    continueOnError: false