<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure MCP Postgres Server Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0078d4;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #323130;
        }
        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input[type="text"]:focus, input[type="url"]:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        button:hover:not(:disabled) {
            background-color: #106ebe;
        }
        button:disabled {
            background-color: #a19f9d;
            cursor: not-allowed;
        }
        .discover-btn {
            background-color: #107c10;
        }
        .discover-btn:hover:not(:disabled) {
            background-color: #0e700e;
        }
        .output {
            background-color: #f8f8f8;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            min-height: 200px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
        }
        .loading {
            color: #0078d4;
            font-style: italic;
        }
        .error {
            color: #d13438;
            background-color: #fdf2f2;
            border-color: #f1aeb5;
        }
        .success {
            color: #107c10;
        }
        .info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e1f5fe;
            border-left: 4px solid #0078d4;
            border-radius: 4px;
        }
        .curl-example {
            background-color: #2d2d30;
            color: #cccccc;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            position: relative;
        }
        .curl-container {
            position: relative;
            margin: 10px 0;
        }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #0078d4;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            z-index: 1;
        }
        .copy-btn:hover {
            background: #106ebe;
        }
        .copy-btn.copied {
            background: #107c10;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h3 {
            color: #323130;
            margin-bottom: 15px;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 5px;
        }
        .collapsible {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .collapsible:after {
            content: '\25BC'; /* Down arrow */
            position: absolute;
            right: 0;
            top: 5px;
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        .collapsible.collapsed:after {
            transform: rotate(-90deg); /* Right arrow */
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.collapsed {
            max-height: 0;
        }
        .collapsible-content:not(.collapsed) {
            max-height: 1000px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Azure MCP Postgres Server Test</h1>
        
        <div class="section">
            <h3>Configuration</h3>
            <div class="form-group">
                <label for="serverUrl">Azure MCP Postgres Server URL:</label>
                <input type="url" id="serverUrl" placeholder="https://your-app.azurecontainerapps.io/" value="https://azure-mcp-postgres-server.prouddesert-9107ba4f.eastus2.azurecontainerapps.io" oninput="updateCurlExamples()">
            </div>
            
            <div class="form-group">
                <label for="accessToken">Access Token:</label>
                <input type="text" id="accessToken" placeholder="Bearer token (obtain from ACI deployed by scripts/deploy-aci-client.sh)..." value="">
            </div>
        </div>

        <div class="section">
            <h3>Actions</h3>
            <div class="button-group">
                <button onclick="listTools()" id="listToolsBtn">List Tools</button>
                <button onclick="discoverPostgres()" id="discoverBtn" class="discover-btn">Run tools discovery call</button>
                <button onclick="clearOutput()" style="background-color: #605e5c;">Clear Output</button>
            </div>
        </div>

        <div class="section">
            <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">Run postgres_database_query tool</h3>
            
            <div class="collapsible-content collapsed">
            <div class="info">
                <span style="font-size: 11px;">If you've run <code>scripts/deploy-azmcp-postgres-server.sh</code>, you can find the SUBSCRIPTION_ID, POSTGRES_RESOURCE_GROUP, and POSTGRES_SERVER_NAME in the generated <code>scripts/deployment-info.json</code> file.</span>
            </div>
            
            <div class="form-group">
                <label for="pgSubscription">Subscription ID:</label>
                <input type="text" id="pgSubscription" placeholder="4d042dc6-fe17-4698-a23f-ec6a8d1e98f4">
            </div>
            
            <div class="form-group">
                <label for="pgResourceGroup">Resource Group:</label>
                <input type="text" id="pgResourceGroup" placeholder="SSS3PT_anuchan-mcp15ccd188">
            </div>
            
            <div class="form-group">
                <label for="pgServer">PostgreSQL Server Name:</label>
                <input type="text" id="pgServer" placeholder="contoso-postgres">
            </div>
            
            <div class="form-group">
                <label for="pgDatabase">Database Name:</label>
                <input type="text" id="pgDatabase" placeholder="postgres" value="postgres">
            </div>

            <div class="form-group">
                <label for="pgUser">Database User (DisplayName of the ACA MI):</label>
                <input type="text" id="pgUser" placeholder="azure-mcp-postgres-server" value="azure-mcp-postgres-server">
            </div>
            
            <div class="form-group">
                <label for="pgQuery">SQL Query:</label>
                <input type="text" id="pgQuery" placeholder="SELECT current_user, current_database(), version();" value="SELECT current_user, current_database(), version();" style="font-family: 'Consolas', 'Monaco', 'Courier New', monospace;">
            </div>
            
            <div class="button-group">
                <button onclick="testPostgresQuery()" id="testQueryBtn" style="background-color: #8a2be2;">Invoke query MCP Tool</button>
            </div>
            </div>
        </div>

        <div class="section">
            <h3>Azure MCP Postgres Server response</h3>
            <div id="output" class="output">Ready to make requests...</div>
        </div>

        <div class="section">
            <h3>Equivalent cURL Commands</h3>
            <div id="curlExamples">
                <p><strong>List Tools:</strong></p>
                <div class="curl-container">
                    <div class="curl-example" id="listToolsCurl">Configure server URL and token first</div>
                    <button class="copy-btn" onclick="copyToClipboard('listToolsCurl', this)">Copy</button>
                </div>
                
                <p><strong>Discover Postgres:</strong></p>
                <div class="curl-container">
                    <div class="curl-example" id="discoverCurl">Configure server URL and token first</div>
                    <button class="copy-btn" onclick="copyToClipboard('discoverCurl', this)">Copy</button>
                </div>
                
                <p><strong>Test Query:</strong></p>
                <div class="curl-container">
                    <div class="curl-example" id="testQueryCurl">Configure server URL and token first</div>
                    <button class="copy-btn" onclick="copyToClipboard('testQueryCurl', this)">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateCurlExamples() {
            const serverUrl = document.getElementById('serverUrl').value;
            const accessToken = document.getElementById('accessToken').value;
            
            if (serverUrl && accessToken) {
                const listToolsCurl = `curl -v -X POST "${serverUrl}" -H "Content-Type: application/json" -H "Accept: application/json, text/event-stream" -H "Authorization: Bearer ${accessToken}" -d '{"jsonrpc": "2.0", "id": "test123", "method": "tools/list", "params": {}}'`;

                const discoverCurl = `curl -s -X POST "${serverUrl}" -H "Content-Type: application/json" -H "Accept: application/json, text/event-stream" -H "Authorization: Bearer ${accessToken}" -d '{"jsonrpc":"2.0","id":"learn1","method":"tools/call","params":{"name":"postgres","arguments":{"learn":true,"intent":"discover"}}}'`;

                // Get current PostgreSQL form values for curl example
                const subscription = document.getElementById('pgSubscription')?.value || '4d042dc6-fe17-4698-a23f-ec6a8d1e98f4';
                const resourceGroup = document.getElementById('pgResourceGroup')?.value || 'SSS3PT_anuchan-mcp15ccd188';
                const user = document.getElementById('pgUser')?.value || 'azure-mcp-postgres-server';
                const server = document.getElementById('pgServer')?.value || 'anuchan321';
                const database = document.getElementById('pgDatabase')?.value || 'postgres';
                const query = document.getElementById('pgQuery')?.value || 'SELECT current_user, current_database(), version();';
                
                const testQueryCurl = `curl -s -X POST "${serverUrl}" -H "Content-Type: application/json" -H "Accept: application/json, text/event-stream" -H "Authorization: Bearer ${accessToken}" -d '{"jsonrpc":"2.0","id":"test-query-123","method":"tools/call","params":{"name":"postgres","arguments":{"command":"postgres_database_query","parameters":{"subscription":"${subscription}","resource-group":"${resourceGroup}","user":"${user}","server":"${server}","database":"${database}","query":"${query.replace(/"/g, '\\"')}"}}}}' `;

                document.getElementById('listToolsCurl').textContent = listToolsCurl;
                document.getElementById('discoverCurl').textContent = discoverCurl;
                document.getElementById('testQueryCurl').textContent = testQueryCurl;
            }
        }

        function copyToClipboard(elementId, button) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                // Success feedback
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(function() {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(function(err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // Success feedback
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(function() {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        // Update curl examples when inputs change
        document.getElementById('serverUrl').addEventListener('input', updateCurlExamples);
        document.getElementById('accessToken').addEventListener('input', updateCurlExamples);
        
        // Also update curl examples when PostgreSQL form fields change
        window.addEventListener('load', function() {
            updateCurlExamples(); // Initial update
            
            const pgFields = ['pgSubscription', 'pgResourceGroup', 'pgUser', 'pgServer', 'pgDatabase', 'pgQuery'];
            pgFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateCurlExamples);
                }
            });
        });
        
        // Also update curl examples when PostgreSQL form fields change
        document.addEventListener('DOMContentLoaded', function() {
            const pgFields = ['pgSubscription', 'pgResourceGroup', 'pgUser', 'pgServer', 'pgDatabase', 'pgQuery'];
            pgFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateCurlExamples);
                }
            });
        });

        function validateInputs() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            
            if (!serverUrl) {
                showError('Please enter the server URL');
                return false;
            }
            
            if (!accessToken) {
                showError('Please enter the access token');
                return false;
            }
            
            try {
                new URL(serverUrl);
            } catch (e) {
                showError('Please enter a valid URL');
                return false;
            }
            
            return true;
        }

        function showLoading(message) {
            const output = document.getElementById('output');
            output.className = 'output loading';
            output.textContent = message;
        }

        function showError(message) {
            const output = document.getElementById('output');
            output.className = 'output error';
            output.textContent = `âŒ Error: ${message}`;
        }

        function showSuccess(data) {
            const output = document.getElementById('output');
            output.className = 'output success';
            output.textContent = `âœ… Success:\n\n${JSON.stringify(data, null, 2)}`;
        }

        function showResponse(data, isError = false) {
            const output = document.getElementById('output');
            output.className = isError ? 'output error' : 'output';
            
            if (typeof data === 'string' && data.includes('event: message\ndata: ')) {
                // Handle Server-Sent Events format
                try {
                    const lines = data.split('\n');
                    const dataLine = lines.find(line => line.startsWith('data: '));
                    if (dataLine) {
                        const jsonStr = dataLine.substring(6); // Remove 'data: ' prefix
                        const jsonData = JSON.parse(jsonStr);
                        
                        // Special handling for discover responses with embedded JSON
                        if (jsonData.result && jsonData.result.content && jsonData.result.content[0] && jsonData.result.content[0].text) {
                            const textContent = jsonData.result.content[0].text;
                            
                            // Look for JSON array in the text content
                            const jsonStart = textContent.indexOf('[');
                            const jsonEnd = textContent.lastIndexOf(']');
                            
                            if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                                try {
                                    // Extract and parse the JSON array
                                    const jsonArrayStr = textContent.substring(jsonStart, jsonEnd + 1);
                                    const jsonArray = JSON.parse(jsonArrayStr);
                                    
                                    // Create a clean response with properly formatted JSON
                                    const cleanResponse = {
                                        ...jsonData,
                                        result: {
                                            ...jsonData.result,
                                            content: [
                                                {
                                                    type: "text",
                                                    text: textContent.substring(0, jsonStart).trim()
                                                },
                                                {
                                                    type: "json",
                                                    data: jsonArray
                                                }
                                            ]
                                        }
                                    };
                                    
                                    output.textContent = JSON.stringify(cleanResponse, null, 2);
                                    return;
                                } catch (e) {
                                    // If JSON parsing fails, fall back to regular formatting
                                    console.log('Failed to parse embedded JSON:', e);
                                }
                            }
                        }
                        
                        output.textContent = JSON.stringify(jsonData, null, 2);
                        return;
                    }
                } catch (e) {
                    // Fall back to showing raw data if parsing fails
                }
            }
            
            if (typeof data === 'object') {
                output.textContent = JSON.stringify(data, null, 2);
            } else {
                output.textContent = data;
            }
        }

        async function makeRequest(payload, actionName) {
            if (!validateInputs()) return;

            const serverUrl = document.getElementById('serverUrl').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            
            showLoading(`Making ${actionName} request...`);
            
            // Disable buttons during request
            document.getElementById('listToolsBtn').disabled = true;
            document.getElementById('discoverBtn').disabled = true;
            document.getElementById('testQueryBtn').disabled = true;
            
            try {
                const response = await fetch(serverUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(payload),
                    mode: 'cors' // Explicitly request CORS
                });

                const responseText = await response.text();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n\nResponse: ${responseText}`);
                }

                // Try to parse as JSON
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    // If not JSON, show as text
                    responseData = responseText;
                }

                showResponse(responseData);
                
            } catch (error) {
                console.error('Request failed:', error);
                
                // Check if it's a CORS error
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    showError(`${actionName} failed due to CORS restrictions. The server needs to allow cross-origin requests from browsers.\n\nError: ${error.message}\n\nðŸ”§ Solutions:\n1. Use the cURL commands shown below instead\n2. Configure CORS in your Azure Container App\n3. Use a browser extension to disable CORS (development only)`);
                } else {
                    showError(`${actionName} failed: ${error.message}`);
                }
            } finally {
                // Re-enable buttons
                document.getElementById('listToolsBtn').disabled = false;
                document.getElementById('discoverBtn').disabled = false;
                document.getElementById('testQueryBtn').disabled = false;
            }
        }

        async function listTools() {
            const payload = {
                jsonrpc: "2.0",
                id: "list-tools-" + Date.now(),
                method: "tools/list",
                params: {}
            };
            
            await makeRequest(payload, "List Tools");
        }

        async function discoverPostgres() {
            const payload = {
                jsonrpc: "2.0",
                id: "discover-" + Date.now(),
                method: "tools/call",
                params: {
                    name: "postgres",
                    arguments: {
                        learn: true,
                        intent: "discover"
                    }
                }
            };
            
            await makeRequest(payload, "Discover Postgres");
        }

        async function testPostgresQuery() {
            // Get values from form fields
            const subscription = document.getElementById('pgSubscription').value.trim();
            const resourceGroup = document.getElementById('pgResourceGroup').value.trim();
            const user = document.getElementById('pgUser').value.trim();
            const server = document.getElementById('pgServer').value.trim();
            const database = document.getElementById('pgDatabase').value.trim();
            const query = document.getElementById('pgQuery').value.trim();
            
            // Validate required fields
            if (!subscription || !resourceGroup || !user || !server || !database || !query) {
                showError('Please fill in all PostgreSQL connection fields');
                return;
            }
            
            const payload = {
                jsonrpc: "2.0",
                id: "test-query-" + Date.now(),
                method: "tools/call",
                params: {
                    name: "postgres",
                    arguments: {
                        command: "postgres_database_query",
                        parameters: {
                            subscription: subscription,
                            "resource-group": resourceGroup,
                            user: user,
                            server: server,
                            database: database,
                            query: query
                        }
                    }
                }
            };
            
            await makeRequest(payload, "Test PostgreSQL Query");
        }

        function clearOutput() {
            const output = document.getElementById('output');
            output.className = 'output';
            output.textContent = 'Output cleared. Ready for next request...';
        }

        function toggleCollapse(element) {
            const content = element.nextElementSibling;
            const isCollapsed = element.classList.contains('collapsed');
            
            if (isCollapsed) {
                element.classList.remove('collapsed');
                content.classList.remove('collapsed');
            } else {
                element.classList.add('collapsed');
                content.classList.add('collapsed');
            }
        }
    </script>
</body>
</html>